# K-memo数据库设计文档

**文档编号：** [003]  
**文档类型：** 核心文档 - 数据库设计  
**创建时间：** 2025-10-25  
**最后更新：** 2025-10-25  
**数据库版本：** v1.0  
**数据库引擎：** SQLite 3.x  

---

## 目录

1. [概述](#概述)
2. [数据库连接配置](#数据库连接配置)
3. [表结构设计](#表结构设计)
4. [索引设计](#索引设计)
5. [数据迁移策略](#数据迁移策略)
6. [数据完整性约束](#数据完整性约束)
7. [性能优化](#性能优化)
8. [备份恢复策略](#备份恢复策略)

---

## 概述

### 数据库选型理由

**选择SQLite的原因：**
1. **轻量级** - 无需独立服务器进程，嵌入式数据库
2. **零配置** - 无需安装和配置，开箱即用
3. **跨平台** - 完全支持Windows、macOS、Linux
4. **事务支持** - 完整的ACID事务支持
5. **Qt集成** - Qt原生支持，通过Qt::Sql模块集成

**技术特性：**
- **单文件存储** - 整个数据库存储在单个文件中
- **文件大小** - 支持最大140TB的数据库
- **并发支持** - 支持多读单写
- **SQL标准** - 支持大部分SQL-92标准

### 数据库文件位置

```
k-memo/
└── data/
    └── kmemo.db        # 主数据库文件
    └── kmemo.db-wal    # Write-Ahead Log文件（如启用WAL模式）
    └── kmemo.db-shm    # 共享内存文件（如启用WAL模式）
```

**数据库路径规则：**
- 开发环境：`./data/kmemo.db`（相对于可执行文件）
- 生产环境：`%APPDATA%/K-memo/data/kmemo.db`（Windows）
- 备份目录：`./data/backups/`

---

## 数据库连接配置

### 连接参数

```cpp
// DatabaseManager初始化配置
QSqlDatabase db = QSqlDatabase::addDatabase("QSQLITE");
db.setDatabaseName("data/kmemo.db");

// 性能优化配置
QSqlQuery query(db);
query.exec("PRAGMA synchronous = NORMAL");     // 同步模式
query.exec("PRAGMA journal_mode = WAL");       // WAL模式（可选）
query.exec("PRAGMA foreign_keys = ON");        // 启用外键约束
query.exec("PRAGMA temp_store = MEMORY");      // 临时表存储在内存
```

### 连接管理

- **单例模式** - 通过`DatabaseManager::instance()`获取唯一实例
- **连接池** - SQLite单文件数据库，不使用连接池
- **线程安全** - 每个线程使用独立的数据库连接
- **自动重连** - 连接失败时自动重试（最多3次）

---

## 表结构设计

### 1. tasks 表（任务主表）

**表说明：** 存储所有任务的核心信息

```sql
CREATE TABLE tasks (
    id TEXT PRIMARY KEY,                    -- 任务唯一标识（UUID）
    title TEXT NOT NULL,                    -- 任务标题（必填）
    description TEXT,                       -- 任务描述（可选）
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,  -- 创建时间
    due_time DATETIME,                      -- 截止时间（可选）
    priority INTEGER DEFAULT 2,             -- 优先级（1=低, 2=普通, 3=高, 4=紧急）
    status INTEGER DEFAULT 0,               -- 状态（0=待办, 1=进行中, 2=已完成, 3=已取消）
    category TEXT DEFAULT 'default',        -- 分类名称
    reminder_enabled BOOLEAN DEFAULT 0,     -- 是否启用提醒
    reminder_minutes INTEGER DEFAULT 15,    -- 提前提醒时间（分钟）
    completed_time DATETIME,                -- 完成时间
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP  -- 最后更新时间
);
```

**字段说明：**

| 字段名 | 类型 | 约束 | 说明 | 默认值 |
|-------|------|------|------|--------|
| id | TEXT | PRIMARY KEY | UUID格式的唯一标识 | 无 |
| title | TEXT | NOT NULL | 任务标题，最长255字符 | 无 |
| description | TEXT | - | 任务详细描述，最长10000字符 | NULL |
| create_time | DATETIME | DEFAULT | 任务创建时间戳 | CURRENT_TIMESTAMP |
| due_time | DATETIME | - | 任务截止时间 | NULL |
| priority | INTEGER | DEFAULT | 优先级枚举值 | 2（普通） |
| status | INTEGER | DEFAULT | 状态枚举值 | 0（待办） |
| category | TEXT | DEFAULT | 分类名称 | 'default' |
| reminder_enabled | BOOLEAN | DEFAULT | 是否启用提醒功能 | 0（关闭） |
| reminder_minutes | INTEGER | DEFAULT | 提前多少分钟提醒 | 15 |
| completed_time | DATETIME | - | 实际完成时间 | NULL |
| updated_time | DATETIME | DEFAULT | 最后修改时间 | CURRENT_TIMESTAMP |

**枚举值定义：**

```cpp
// TaskPriority枚举（priority字段）
enum class TaskPriority {
    Low = 1,      // 低优先级
    Normal = 2,   // 普通优先级
    High = 3,     // 高优先级
    Urgent = 4    // 紧急优先级
};

// TaskStatus枚举（status字段）
enum class TaskStatus {
    Pending = 0,      // 待办
    InProgress = 1,   // 进行中
    Completed = 2,    // 已完成
    Cancelled = 3     // 已取消
};
```

**业务规则：**
1. `id`必须是有效的UUID格式（由程序生成）
2. `title`不能为空，且长度在1-255字符之间
3. `due_time`如果设置，必须大于`create_time`
4. `status`为`Completed`时，`completed_time`应自动设置为当前时间
5. 每次更新任务时，`updated_time`应自动更新

---

### 2. task_tags 表（任务标签关联表）

**表说明：** 多对多关系表，关联任务和标签

```sql
CREATE TABLE task_tags (
    task_id TEXT NOT NULL,                  -- 任务ID
    tag TEXT NOT NULL,                      -- 标签名称
    PRIMARY KEY (task_id, tag),             -- 复合主键
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
);
```

**字段说明：**

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| task_id | TEXT | PRIMARY KEY, FK | 关联tasks表的id |
| tag | TEXT | PRIMARY KEY | 标签名称 |

**关系说明：**
- **多对多关系** - 一个任务可以有多个标签，一个标签可以关联多个任务
- **级联删除** - 删除任务时，自动删除相关的标签关联记录
- **复合主键** - (task_id, tag)组合唯一，防止重复关联

**业务规则：**
1. 同一任务不能重复添加相同标签
2. 标签名称不能为空，长度在1-50字符之间
3. 标签名称区分大小写

---

### 3. app_config 表（应用配置表）

**表说明：** 存储应用级别的配置信息

```sql
CREATE TABLE app_config (
    key TEXT PRIMARY KEY,                   -- 配置键名
    value TEXT,                             -- 配置值
    description TEXT,                       -- 配置说明
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP  -- 更新时间
);
```

**字段说明：**

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| key | TEXT | PRIMARY KEY | 配置项的唯一键名 |
| value | TEXT | - | 配置项的值（JSON或字符串） |
| description | TEXT | - | 配置项说明 |
| updated_time | DATETIME | DEFAULT | 最后更新时间 |

**预定义配置项：**

| Key | Value类型 | 说明 | 默认值 |
|-----|----------|------|--------|
| db_version | INTEGER | 数据库架构版本号 | 1 |
| app_version | TEXT | 应用程序版本 | "1.0.0" |
| last_backup_time | DATETIME | 上次备份时间 | NULL |
| default_category | TEXT | 默认分类名称 | "default" |
| window_geometry | TEXT | 窗口位置和大小（序列化） | NULL |
| window_state | TEXT | 窗口状态 | NULL |

**使用示例：**

```sql
-- 插入配置
INSERT INTO app_config (key, value, description) 
VALUES ('db_version', '1', '数据库架构版本');

-- 查询配置
SELECT value FROM app_config WHERE key = 'db_version';

-- 更新配置
UPDATE app_config 
SET value = '2', updated_time = CURRENT_TIMESTAMP 
WHERE key = 'db_version';
```

---

## 索引设计

### 主键索引（自动创建）

```sql
-- tasks表主键索引
CREATE UNIQUE INDEX idx_tasks_id ON tasks(id);

-- task_tags表复合主键索引
CREATE UNIQUE INDEX idx_task_tags_pk ON task_tags(task_id, tag);

-- app_config表主键索引
CREATE UNIQUE INDEX idx_app_config_key ON app_config(key);
```

### 业务查询索引

```sql
-- 按分类查询索引
CREATE INDEX idx_tasks_category ON tasks(category);

-- 按状态查询索引
CREATE INDEX idx_tasks_status ON tasks(status);

-- 按优先级查询索引
CREATE INDEX idx_tasks_priority ON tasks(priority);

-- 按截止时间查询索引（用于查找即将到期的任务）
CREATE INDEX idx_tasks_due_time ON tasks(due_time) 
WHERE due_time IS NOT NULL;

-- 按创建时间查询索引（用于排序）
CREATE INDEX idx_tasks_create_time ON tasks(create_time DESC);

-- 按更新时间查询索引
CREATE INDEX idx_tasks_updated_time ON tasks(updated_time DESC);

-- 标签查询索引
CREATE INDEX idx_task_tags_tag ON task_tags(tag);
```

### 复合索引

```sql
-- 按状态和优先级组合查询
CREATE INDEX idx_tasks_status_priority ON tasks(status, priority);

-- 按分类和状态组合查询
CREATE INDEX idx_tasks_category_status ON tasks(category, status);

-- 按状态和截止时间组合查询（查找待办且即将到期的任务）
CREATE INDEX idx_tasks_status_due ON tasks(status, due_time) 
WHERE due_time IS NOT NULL;
```

### 索引使用建议

1. **频繁查询字段** - 为WHERE、ORDER BY、JOIN中频繁使用的字段创建索引
2. **选择性高的字段** - 优先为选择性高（值分布广）的字段建立索引
3. **避免过度索引** - 过多索引会影响INSERT/UPDATE性能
4. **定期维护** - 使用`VACUUM`和`ANALYZE`优化数据库

---

## 数据迁移策略

### 版本管理

**版本号存储：**
```sql
-- 在app_config表中存储当前数据库版本
INSERT INTO app_config (key, value, description) 
VALUES ('db_version', '1', '当前数据库架构版本');
```

**版本检查流程：**
```cpp
// DatabaseManager初始化时检查版本
int currentVersion = getDatabaseVersion();  // 从app_config读取
int targetVersion = 1;  // 应用程序要求的版本

if (currentVersion < targetVersion) {
    migrate(currentVersion, targetVersion);
}
```

### 迁移脚本

#### v1.0 → v1.1 迁移示例

```sql
-- 开始事务
BEGIN TRANSACTION;

-- 1. 添加新字段
ALTER TABLE tasks ADD COLUMN archived BOOLEAN DEFAULT 0;
ALTER TABLE tasks ADD COLUMN archived_time DATETIME;

-- 2. 创建新索引
CREATE INDEX idx_tasks_archived ON tasks(archived);

-- 3. 更新版本号
UPDATE app_config SET value = '2' WHERE key = 'db_version';

-- 4. 提交事务
COMMIT;
```

### 迁移失败回滚

```cpp
bool DatabaseManager::migrate(int from, int to) {
    QSqlDatabase::database().transaction();
    
    try {
        // 执行迁移脚本
        for (int v = from; v < to; v++) {
            executeMigrationScript(v, v+1);
        }
        
        // 提交事务
        QSqlDatabase::database().commit();
        return true;
        
    } catch (const std::exception& e) {
        // 回滚事务
        QSqlDatabase::database().rollback();
        qCritical() << "迁移失败:" << e.what();
        return false;
    }
}
```

---

## 数据完整性约束

### 主键约束

```sql
-- tasks表主键
PRIMARY KEY (id)

-- task_tags表复合主键
PRIMARY KEY (task_id, tag)

-- app_config表主键
PRIMARY KEY (key)
```

### 外键约束

```sql
-- task_tags表外键约束
FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE

-- 说明：删除任务时，自动删除关联的标签记录
```

### 非空约束

```sql
-- tasks表必填字段
title TEXT NOT NULL

-- task_tags表必填字段
task_id TEXT NOT NULL
tag TEXT NOT NULL
```

### 检查约束（通过触发器实现）

```sql
-- 优先级范围检查
CREATE TRIGGER check_priority_range
BEFORE INSERT ON tasks
FOR EACH ROW
WHEN NEW.priority NOT BETWEEN 1 AND 4
BEGIN
    SELECT RAISE(ABORT, '优先级必须在1-4之间');
END;

-- 状态范围检查
CREATE TRIGGER check_status_range
BEFORE INSERT ON tasks
FOR EACH ROW
WHEN NEW.status NOT BETWEEN 0 AND 3
BEGIN
    SELECT RAISE(ABORT, '状态必须在0-3之间');
END;

-- 截止时间检查
CREATE TRIGGER check_due_time
BEFORE INSERT ON tasks
FOR EACH ROW
WHEN NEW.due_time IS NOT NULL AND NEW.due_time < NEW.create_time
BEGIN
    SELECT RAISE(ABORT, '截止时间不能早于创建时间');
END;
```

### 自动更新触发器

```sql
-- 自动更新updated_time字段
CREATE TRIGGER update_tasks_timestamp
AFTER UPDATE ON tasks
FOR EACH ROW
BEGIN
    UPDATE tasks SET updated_time = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;

-- 自动设置完成时间
CREATE TRIGGER set_completed_time
AFTER UPDATE ON tasks
FOR EACH ROW
WHEN NEW.status = 2 AND OLD.status != 2 AND NEW.completed_time IS NULL
BEGIN
    UPDATE tasks SET completed_time = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;
```

---

## 性能优化

### 查询优化

**1. 使用索引覆盖查询**
```sql
-- 优化前
SELECT id, title FROM tasks WHERE status = 0;

-- 优化后（使用covering index）
CREATE INDEX idx_tasks_status_covering ON tasks(status, id, title);
```

**2. 避免SELECT * **
```sql
-- 不推荐
SELECT * FROM tasks WHERE id = '...';

-- 推荐：只查询需要的字段
SELECT id, title, status, priority FROM tasks WHERE id = '...';
```

**3. 使用LIMIT分页**
```sql
-- 分页查询
SELECT * FROM tasks 
ORDER BY create_time DESC 
LIMIT 20 OFFSET 0;
```

### 批量操作优化

**使用事务包装批量操作：**
```cpp
QSqlDatabase::database().transaction();

for (const auto& task : tasks) {
    insertTask(task);
}

QSqlDatabase::database().commit();
```

### 数据库维护

```sql
-- 分析表统计信息（优化查询计划）
ANALYZE;

-- 重建数据库（回收空间、整理碎片）
VACUUM;

-- 增量分析（仅分析变化的表）
ANALYZE tasks;
```

### WAL模式优化

```sql
-- 启用WAL模式（提升并发性能）
PRAGMA journal_mode = WAL;

-- WAL检查点配置
PRAGMA wal_autocheckpoint = 1000;  -- 每1000页自动checkpoint
PRAGMA wal_checkpoint(TRUNCATE);    -- 手动执行checkpoint
```

---

## 备份恢复策略

### 备份策略

**1. 完整备份**
```cpp
bool DatabaseManager::backup(const QString& backupPath) {
    QFile sourceFile("data/kmemo.db");
    QString timestamp = QDateTime::currentDateTime().toString("yyyyMMdd_HHmmss");
    QString backupFile = QString("%1/kmemo_%2.db").arg(backupPath, timestamp);
    
    return sourceFile.copy(backupFile);
}
```

**2. 自动备份规则**
- **频率：** 每周自动备份一次
- **保留策略：** 保留最近30天的备份
- **存储位置：** `data/backups/`目录
- **文件命名：** `kmemo_YYYYMMDD_HHmmss.db`

**3. 备份前检查**
```cpp
bool checkDatabaseIntegrity() {
    QSqlQuery query("PRAGMA integrity_check");
    query.next();
    return query.value(0).toString() == "ok";
}
```

### 恢复策略

**1. 从备份恢复**
```cpp
bool DatabaseManager::restore(const QString& backupFile) {
    // 1. 关闭当前连接
    close();
    
    // 2. 备份当前数据库（双重保险）
    QFile::copy("data/kmemo.db", "data/kmemo.db.emergency");
    
    // 3. 覆盖当前数据库
    QFile::remove("data/kmemo.db");
    QFile::copy(backupFile, "data/kmemo.db");
    
    // 4. 重新打开数据库
    return open();
}
```

**2. 数据导出（JSON格式）**
```cpp
QString exportToJson() {
    QJsonArray tasksArray;
    QSqlQuery query("SELECT * FROM tasks");
    
    while (query.next()) {
        QJsonObject taskObj;
        // 序列化任务数据
        tasksArray.append(taskObj);
    }
    
    QJsonDocument doc(tasksArray);
    return doc.toJson();
}
```

---

## 常见查询示例

### 基础查询

```sql
-- 查询所有待办任务
SELECT * FROM tasks WHERE status = 0 ORDER BY priority DESC, due_time ASC;

-- 查询今日到期任务
SELECT * FROM tasks 
WHERE date(due_time) = date('now') 
  AND status != 2
ORDER BY priority DESC;

-- 查询逾期任务
SELECT * FROM tasks 
WHERE due_time < datetime('now') 
  AND status != 2 
  AND status != 3
ORDER BY due_time ASC;

-- 按分类统计任务
SELECT category, COUNT(*) as count 
FROM tasks 
GROUP BY category;

-- 按优先级统计待办任务
SELECT priority, COUNT(*) as count 
FROM tasks 
WHERE status = 0 
GROUP BY priority;
```

### 标签相关查询

```sql
-- 查询某个任务的所有标签
SELECT tag FROM task_tags WHERE task_id = '...';

-- 查询包含特定标签的所有任务
SELECT t.* 
FROM tasks t
INNER JOIN task_tags tt ON t.id = tt.task_id
WHERE tt.tag = '工作';

-- 查询某任务的标签数量
SELECT COUNT(*) 
FROM task_tags 
WHERE task_id = '...';

-- 查询所有标签及其使用次数
SELECT tag, COUNT(*) as count 
FROM task_tags 
GROUP BY tag 
ORDER BY count DESC;
```

### 统计查询

```sql
-- 任务完成率统计
SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) as completed,
    CAST(SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) AS REAL) / COUNT(*) * 100 as completion_rate
FROM tasks;

-- 本周新增任务数
SELECT COUNT(*) 
FROM tasks 
WHERE create_time >= date('now', '-7 days');

-- 各分类任务分布
SELECT 
    category,
    COUNT(*) as total,
    SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) as completed
FROM tasks 
GROUP BY category;
```

---

## 数据库维护计划

### 日常维护

| 频率 | 操作 | 说明 |
|-----|------|------|
| 每日 | 检查数据库连接 | 确保数据库文件可访问 |
| 每周 | ANALYZE | 更新表统计信息 |
| 每月 | VACUUM | 回收空间、整理碎片 |
| 每月 | 完整性检查 | PRAGMA integrity_check |

### 监控指标

- 数据库文件大小
- 查询响应时间
- 索引命中率
- WAL文件大小（如启用）

---

## 附录

### 数据库初始化SQL

```sql
-- 完整的数据库初始化脚本
-- Version: 1.0

-- 1. 创建tasks表
CREATE TABLE IF NOT EXISTS tasks (
    id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    due_time DATETIME,
    priority INTEGER DEFAULT 2,
    status INTEGER DEFAULT 0,
    category TEXT DEFAULT 'default',
    reminder_enabled BOOLEAN DEFAULT 0,
    reminder_minutes INTEGER DEFAULT 15,
    completed_time DATETIME,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 2. 创建task_tags表
CREATE TABLE IF NOT EXISTS task_tags (
    task_id TEXT NOT NULL,
    tag TEXT NOT NULL,
    PRIMARY KEY (task_id, tag),
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
);

-- 3. 创建app_config表
CREATE TABLE IF NOT EXISTS app_config (
    key TEXT PRIMARY KEY,
    value TEXT,
    description TEXT,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 4. 创建索引
CREATE INDEX IF NOT EXISTS idx_tasks_category ON tasks(category);
CREATE INDEX IF NOT EXISTS idx_tasks_status ON tasks(status);
CREATE INDEX IF NOT EXISTS idx_tasks_priority ON tasks(priority);
CREATE INDEX IF NOT EXISTS idx_tasks_due_time ON tasks(due_time);
CREATE INDEX IF NOT EXISTS idx_tasks_create_time ON tasks(create_time DESC);
CREATE INDEX IF NOT EXISTS idx_task_tags_tag ON task_tags(tag);

-- 5. 插入初始配置
INSERT OR IGNORE INTO app_config (key, value, description) 
VALUES ('db_version', '1', '数据库架构版本');

INSERT OR IGNORE INTO app_config (key, value, description) 
VALUES ('app_version', '1.0.0', '应用程序版本');
```

---

**文档维护人：** AI开发助手  
**审核人：** 项目负责人  
**下次审查时间：** 2025-11-25

